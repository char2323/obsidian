### **一、 项目概述与最终成果**

本项目成功地将一个基于 Python 2 和 Vue 2 的老旧电影票务系统，全面重构为一个采用现代主流技术的全栈应用。我们保留了原始设计的优秀模块化思想，同时解决了其技术过时、依赖废弃、开发流程繁琐等核心问题。

**最终成果**是一个功能完整、技术现代、界面美观、开发流程清晰的电影票务系统，具备用户认证、电影浏览、在线购票、订单管理、电影收藏与评论等核心功能。

### **二、 数据库部分详解**

数据库是我们这次重构的核心，我们建立了一套完整、健壮且易于维护的数据管理体系。

#### **1. 数据库选型**

- **系统**: **MariaDB**。作为 MySQL 的一个完全开源的分支，它与 MySQL 高度兼容，性能稳定可靠。
    
- **驱动**: 在 Docker 环境中使用 `mysqlclient` 以获得最佳性能；在本地 Conda 环境中使用纯 Python 的 `PyMySQL` 以获得最佳兼容性。
    

#### **2. 数据模型 (ORM)**

我们使用 **SQLAlchemy** 作为 ORM (对象关系映射) 工具，在 `app/models.py` 文件中以 Python 类的形式，直观地定义了所有数据表的结构。

- **核心模型**: `User`, `Movie`, `Screen`, `Order`, `Comment`, `Favorite`, `Coupon`。
    
- **关键特性**:
    
    - **关系明确**: 通过 `db.ForeignKey` 和 `db.relationship` 清晰地定义了实体间的一对多、多对多关系。
        
    - **数据安全**: `User` 模型内置了密码的哈希生成和验证逻辑，确保原始密码绝不入库。
        
    - **灵活存储**: `Screen` 模型使用 `JSON` 数据类型来存储和管理每个场次独有的座位图，兼具了关系型数据库的严谨性和非关系型数据库的灵活性。
        

#### **3. 数据库结构迁移 (Schema Migration)**

- **工具**: **Alembic** 及其 Flask 集成工具 **Flask-Migrate**。
    
- **解决了什么问题**: 告别了手动修改数据库表结构的原始方式。现在，对数据库结构的任何改动（如增删字段、修改类型）都有版本化的脚本记录。
    
- **工作流程**:
    
    1. 修改 `app/models.py` 中的 Python 类。
        
    2. 运行 `docker-compose exec backend flask db migrate -m "改动说明"`，自动生成差异脚本。
        
    3. 运行 `docker-compose exec backend flask db upgrade`，将改动安全地应用到数据库。
        
- **优势**: 保证了团队协作时数据库结构的一致性，使得部署和回滚变得简单可靠。
    

#### **4. 数据库内容填充 (Data Seeding)**

- **解决了什么问题**: 避免了在后台手动逐条添加大量初始数据的低效工作。
    
- **实现方式**: 通过自定义 Flask CLI 命令。
    
    - **`scraper.py`**: 一个独立的 Python 爬虫脚本，使用 `requests` 和 `BeautifulSoup4` 库，通过携带 Cookie 的方式绕过反爬虫机制，自动从豆瓣 Top 250 抓取详细的电影数据，并保存为 `seed_data.json`。
        
    - **`flask seed`**: 读取 `seed_data.json` 文件，将电影数据批量写入数据库。
        
    - **`flask seed-screens`**: 自动为数据库中已存在的电影，随机生成大量逼真的模拟场次数据。
        

### **三、 项目文件结构详解**

#### **后端 (`Flask-Server/`)**

```
Flask-Server/
├── app/                      # Flask 应用核心代码目录
│   ├── api/                  # 存放所有 API 接口的模块
│   │   ├── __init__.py       # 初始化 API 蓝图并注册所有接口
│   │   ├── user.py           # 用户注册接口
│   │   ├── session.py        # 用户登录/退出/状态检查接口
│   │   └── ... (movie, screen, order, comment, favorite, coupon 等接口)
│   ├── __init__.py           # 应用工厂，负责创建和配置 Flask 应用实例
│   ├── models.py             # 定义所有数据库表的 SQLAlchemy ORM 模型
│   └── admin.py              # 定义 Flask-Admin 的后台管理视图
├── migrations/               # 由 Flask-Migrate 自动生成的数据库迁移脚本目录
├── .env.docker               # Docker 环境专用的配置文件 (数据库地址, 密钥等)
├── config.py                 # 从 .env 文件加载配置的 Python 文件
├── Dockerfile                # 定义如何构建后端服务的 Docker 镜像
├── docker-compose.yml        # 定义和编排后端、数据库、缓存等多个 Docker 服务
├── gunicornConf.py           # Gunicorn WSGI 服务器的配置文件
├── requirements.txt          # 项目的所有 Python 依赖包列表
├── scraper.py                # 独立的豆瓣电影爬虫脚本
├── seed_data.json            # 由爬虫生成的、用于填充数据库的电影数据
└── server.py                 # 项目的顶层入口文件，并注册了自定义的 seed 命令
```

#### **前端 (`MonkeyEye-FE/`)**

```
MonkeyEye-FE/
├── public/                   # 存放不会被构建处理的静态资源
├── src/                      # 前端应用核心代码目录
│   ├── assets/               # 存放全局 CSS 文件 (main.css) 和图片等
│   ├── router/               # 路由配置目录
│   │   └── index.ts          # 定义所有页面路由和全局路由守卫
│   ├── services/             # API 服务目录
│   │   └── api.ts            # 封装 axios 实例，作为统一的后端请求出口
│   ├── stores/               # Pinia 状态管理目录
│   │   └── auth.ts           # 管理用户登录状态、信息，并封装登录/注册等 action
│   ├── views/                # 存放页面级组件的目录
│   │   ├── auth/             # 登录(SigninView.vue)和注册(SignupView.vue)页面
│   │   ├── movie/            # 电影列表(MoviesView.vue)和详情(MovieDetailView.vue)页面
│   │   ├── order/            # 选场次、选座、确认订单页面
│   │   ├── profile/          # 个人中心主页、我的订单、优惠券、收藏页面
│   │   └── MainView.vue      # 登录后承载大部分页面的主布局组件
│   ├── App.vue               # Vue 应用的根组件，只包含 <RouterView />
│   └── main.ts               # 应用的主入口文件，负责初始化 Vue, Pinia, Router
├── index.html                # 应用的 HTML 主入口
├── package.json              # 项目的 npm 依赖和脚本配置
├── tailwind.config.js        # Tailwind CSS 的配置文件
├── postcss.config.js         # PostCSS 的配置文件
└── vite.config.ts            # Vite 构建工具的配置文件
```

### **四、 部署与日常开发流程**

我们最终采用 **Docker** 进行后端部署，这是最稳定、最可靠的方案。

#### **首次/全新部署**

1. **启动 Docker Desktop**。
    
2. **后端**: 进入 `Flask-Server` 目录，运行 `docker-compose up --build -d` 启动所有服务。
    
3. **数据库初始化**: 依次运行 `docker-compose exec backend flask db init`, `migrate`, `upgrade`。
    
4. **数据填充**: （可选）在本地 Conda 环境中运行 `python scraper.py`，然后运行 `docker-compose exec backend flask seed` 和 `seed-screens`。
    
5. **前端**: 进入 `MonkeyEye-FE` 目录，运行 `npm install`（仅首次），然后 `npm run dev`。
    

#### **日常重启**

1. **启动 Docker Desktop**。
    
2. **终端一 (后端)**: `cd Flask-Server`, `docker-compose up -d`。
    
3. **终端二 (前端)**: `cd MonkeyEye-FE`, `npm run dev`。
    

#### **代码更新**

- **修改后端 Python 代码**: 保存后，运行 `docker-compose restart backend`。
    
- **修改后端 `requirements.txt`**: 保存后，运行 `docker-compose up --build -d`。
    
- **修改前端代码**: 保存后，Vite 会自动热更新，无需操作。
    

这份文档总结了我们项目的全貌。从一个陈旧的起点，我们共同构建了一个技术先进、结构清晰、流程完整的现代化应用。恭喜您完成了这次意义非凡的重构之旅！